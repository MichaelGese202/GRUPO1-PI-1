#include <WiFi.h>
#include <WiFiUdp.h>
#include <OneWire.h>
#include <DallasTemperature.h>
#include <HardwareSerial.h>

// ============================
//        WIFI + UDP
// ============================
const char* ssid = "Heredia";
const char* password = "12345678";

const char* udpServerIP = "172.20.24.190";
const int udpServerPort = 5005;
WiFiUDP udp;
const int localUdpPort = 12345;

// ============================
//    DS18B20 (TEMPERATURA)
// ============================
#define ONE_WIRE_BUS 16
OneWire oneWire(ONE_WIRE_BUS);
DallasTemperature sensors(&oneWire);

// ============================
//     SENSOR ANALÃ“GICO (HUMEDAD SUELO)
// ============================
#define ANALOG_PIN 32

// Valores calibrados del sensor
const int valor_aire = 2400; // valor sensor fuera de tierra (seco)
const int valor_tierra_humedad_media = 900; // valor sensor en tierra media hÃºmeda

// ============================
//     SENSOR NPK - MODBUS
// ============================
#define RXD2 4
#define TXD2 17
#define DE   19
#define RE   18

HardwareSerial mod(2);

const byte cmdN[] = {0x01,0x03,0x00,0x1E,0x00,0x01,0xE4,0x0C};
const byte cmdP[] = {0x01,0x03,0x00,0x1F,0x00,0x01,0xB5,0xCC};
const byte cmdK[] = {0x01,0x03,0x00,0x20,0x00,0x01,0x85,0xC0};

byte buffer[10];

// ============================
//    FUNCIONES MODBUS
// ============================
void limpiarBuffer() {
  while (mod.available()) mod.read();
}

int leerValor(const byte *cmd) {
  limpiarBuffer();

  digitalWrite(DE, HIGH);
  digitalWrite(RE, HIGH);
  delay(2);
  mod.write(cmd, 8);
  mod.flush();

  digitalWrite(DE, LOW);
  digitalWrite(RE, LOW);

  unsigned long t0 = millis();
  int idx = 0;

  while (millis() - t0 < 200) {
    if (mod.available() && idx < sizeof(buffer)) buffer[idx++] = mod.read();
  }

  if (idx != 7) return -1;

  return buffer[3] * 256 + buffer[4];
}

// ============================
//          SETUP
// ============================
void setup() {
  Serial.begin(115200);
  delay(500);

  // WiFi
  Serial.println("\nConectando al WiFi...");
  WiFi.begin(ssid, password);

  int intentos = 0;
  while (WiFi.status() != WL_CONNECTED && intentos < 20) {
    Serial.print(".");
    delay(1000);
    intentos++;
  }

  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\nWiFi OK!");
    Serial.print("IP ESP32: ");
    Serial.println(WiFi.localIP());
  } else {
    Serial.println("\nNO se pudo conectar.");
  }

  udp.begin(localUdpPort);

  // DS18B20
  sensors.begin();

  // ANALÃ“GICO
  pinMode(ANALOG_PIN, INPUT);

  // NPK
  mod.begin(9600, SERIAL_8N1, RXD2, TXD2);
  pinMode(DE, OUTPUT);
  pinMode(RE, OUTPUT);
  digitalWrite(DE, LOW);
  digitalWrite(RE, LOW);

  Serial.println("Sensores inicializados.");
}

// ============================
//           LOOP
// ============================
void loop() {

  // -------------------
  //   DS18B20
  // -------------------
  sensors.requestTemperatures();
  float tempC = sensors.getTempCByIndex(0);
  if (tempC == DEVICE_DISCONNECTED_C) tempC = -100.0;

  // -------------------
  //   SENSOR HUMEDAD SUELO
  // -------------------
  int humedad_raw = analogRead(ANALOG_PIN);

  // Convertir a porcentaje (0% = seco, 100% = muy hÃºmedo)
  float humedad = 100.0 * (valor_aire - humedad_raw) / (valor_aire - valor_tierra_humedad_media);
  if (humedad < 0) humedad = 0;
  if (humedad > 100) humedad = 100;

  // Estado del suelo
  String estadoHumedad;
  if (humedad < 30) {
    estadoHumedad = "Seco";
  } else if (humedad >= 30 && humedad < 70) {
    estadoHumedad = "Perfecto";
  } else {
    estadoHumedad = "Muy hÃºmedo";
  }

  // -------------------
  //   SENSOR NPK
  // -------------------
  int N = leerValor(cmdN);  delay(150);
  int P = leerValor(cmdP);  delay(150);
  int K = leerValor(cmdK);  delay(150);

  // -------------------
  //     JSON UDP
  // -------------------
  String json = "{";
  json += "\"humidity\":" + String(humedad, 2) + ",";
  json += "\"temperature\":" + String(tempC, 2) + ",";
  json += "\"soil_status\":\"" + estadoHumedad + "\",";
  json += "\"n\":" + String(N) + ",";
  json += "\"p\":" + String(P) + ",";
  json += "\"k\":" + String(K);
  json += "}";

  Serial.println("ðŸ“¤ Enviando JSON:");
  Serial.println(json);

  // Enviar por UDP
  udp.beginPacket(udpServerIP, udpServerPort);
  udp.print(json);
  udp.endPacket();

  Serial.println("âœ… Enviado via UDP\n");

  delay(5000);
}
