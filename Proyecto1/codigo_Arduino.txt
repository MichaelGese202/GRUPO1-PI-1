#include <WiFi.h>
#include <WiFiUdp.h>

// ======== CONFIGURACIÃ“N DE RED ========
const char* ssid = "UPCH_CENTRAL";      // ğŸ”¹ Cambia por tu red
const char* password = "CAYETANO2022";  // ğŸ”¹ Cambia por tu contraseÃ±a

// ======== CONFIGURACIÃ“N DEL SERVIDOR UDP ========
const char* udpAddress = "172.20.24.190";  // ğŸ”¹ IP de tu laptop (Flask server)
const int udpPort = 5005;                  // ğŸ”¹ Puerto UDP del servidor Flask

WiFiUDP udp;

// ======== SENSOR EN PIN D34 ========
const int sensorPin = 34;  // GPIO34 (entrada analÃ³gica, solo lectura)

// FunciÃ³n para leer temperatura en Â°C desde LM35
float leerTemperatura() {
  int lectura = analogRead(sensorPin);
  float voltaje = (lectura / 4095.0) * 3.3;  // Convertir a voltaje (ADC de 12 bits, ref 3.3V)
  float temperatura = voltaje * 100.0;       // LM35: 10mV/Â°C â†’ 1V = 100Â°C
  return temperatura;
}

void setup() {
  Serial.begin(115200);
  delay(1000);

  Serial.println("\nğŸŒ Conectando al WiFi...");
  WiFi.begin(ssid, password);

  int intentos = 0;
  while (WiFi.status() != WL_CONNECTED && intentos < 20) {
    delay(1000);
    Serial.print(".");
    intentos++;
  }

  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\nâœ… ConexiÃ³n WiFi exitosa!");
    Serial.print("DirecciÃ³n IP del ESP32: ");
    Serial.println(WiFi.localIP());
  } else {
    Serial.println("\nâŒ No se pudo conectar al WiFi.");
  }

  // Iniciar UDP
  udp.begin(udpPort);
  Serial.println("ğŸ“¡ UDP iniciado.");
}

void loop() {
  // ğŸ”¹ Leer temperatura real desde el pin D34
  float temperatura = leerTemperatura();

  // ğŸ”¹ Simular otros valores de sensores
  float humedad = random(30, 80);  // %
  float n = random(10, 50);        // N
  float p = random(5, 30);         // P
  float k = random(5, 40);         // K

  // ğŸ”¹ Formato del mensaje: "humedad,temperatura,n,p,k"
  char mensaje[64];
  snprintf(mensaje, sizeof(mensaje), "%.2f,%.2f,%.2f,%.2f,%.2f", humedad, temperatura, n, p, k);

  Serial.print("ğŸ“¤ Enviando datos UDP: ");
  Serial.println(mensaje);

  // ğŸ”¹ Enviar al servidor Flask
  udp.beginPacket(udpAddress, udpPort);
  udp.write((uint8_t*)mensaje, strlen(mensaje));  // âœ… EnvÃ­o correcto de texto
  udp.endPacket();


  delay(5000);  // Espera 5 segundos entre envÃ­os
}
